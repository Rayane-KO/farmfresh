{% extends "base.html" %}
{% load bootstrap4 %}
{% load static %}
{% block content %}

<!-- CSS Styles for Farmer List and Map -->
<style>
    /* Styles for the main list container */
    .containerDelete {
        margin-top: 3%;
        text-align: center;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 4%;
        padding-bottom: 70px;
    }

    h1 {
        margin-top: -50px; 
    }

    /* Styles for user info items in the list */
    .user-info {
        border: 1px solid #0a5200;
        padding: 10px;
        border-radius: 5px;
        margin-top: 30px;
        position: relative; /* Position relative for absolute positioning of image */
    }

    /* Styles for user info image */
    .user-info img {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        right: 20px;
    }

    /* Styles for the map container */
    #map-container {
        position: fixed;
        top: 150px;
        right: 20px;
        z-index: 1;
    }

    /* Styles for the map */
    #map {
        height: 600px;
        width: 100%;
        max-width: 650px;
        margin-top: 112px;
        margin-bottom: 50px;
        border: #ddd; 
    }

    /* Styles for filter options */
    .filter-options {
        margin-top: 20px;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        width: fit-content;
    }

    /* Styles for filter option buttons */
    .filter-options form {
        display: flex;
        flex-direction: column;
    }

    /* Styles for clear and apply filter buttons */
    .clear-button,
    .apply-button {
        background-color: #e74c3c; 
        border-radius: 10px;
        color: #fff;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
    }

    .clear-button:hover {
        background-color: #c0392b; 
    }

    .apply-button:hover {
        background-color: #2980b9; /
    }
</style>

<div class="container farmer_list">
    <h1>Farmers</h1>
    <!-- Filter options for farmers -->
    <div class="filter-options">
        <h5>Filter farmers</h5>
        <form method="get">
            <label>
                <input type="radio" name="best_farmers" value="best" {% if request.GET.filter == 'best' %}checked{% endif %}>
                Best Rated
            </label>
            <label>
                <input type="radio" name="closest_farmers" value="closest" {% if request.GET.filter == 'closest' %}checked{% endif %}>
                Closest
            </label>
            <label><input type="checkbox" name="fav_farmers" id="fav" data-id={{ user.pk }} data-url={% url "accounts:user_list" %}> Favorites </label>
            <div class="filter-buttons">
                <button type="submit" class="apply-button">Apply Filter</button>
                <button type="button" id="clear-filters" class="clear-button">Clear Filters</button>
            </div>
        </form>
    </div>
    
    <!-- Farmer List -->
    <div class="row">
        <div class="col-md-6 order-md-1 order-2">
            {% if farmers %}
                <ul>
                    {% for farmer in farmers %}
                        <li>
                            <!-- User info details for each farmer -->
                            <div class="user-info" data-user-id={{ user.pk }} data-id={{ farmer.pk }} data-latitude={{ farmer.latitude }} data-longitude={{ farmer.longitude }} data-username={{ farmer.username }}>
                                <img src="{{ farmer.profile_pic.url }}" alt="{{ farmer.username }} Profile Picture">
                                <p>Name: {{ farmer.username }}</p>
                                <p>Farm: {{ farmer.farm_nr }}</p>
                                <p>Address: {{ farmer.address }} </p>      
                                <a href="{% url "accounts:user_detail" pk=farmer.pk %}">View Details</a>
                                {% if farmer != user and user.is_authenticated %}
                                    <button class="fav-button" data-farmer-id={{ farmer.pk }} data-auth={{ user.is_authenticated }}>
                                        <i class="fa-regular fa-star" style="color: #ffd43b;"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No farmers available yet...</p>
            {% endif %}
        </div>
        <!-- Map container -->
        <div class="col-md-6 order-md-2 order-1" id="map-container">
            <div id="map"></div>
        </div>
    </div>
</div>

<!-- JavaScript for handling favorite farmers and updating map position -->
<script src="{% static "farmfresh/js/fav_farmer.js" %}"></script>
<script src="{% static "farmfresh/js/map.js" %}"></script>

<script>
    // Function to extract CSRF token from cookies
    function getToken(){
        var val = "; " + document.cookie;
        var parts = val.split("; csrftoken=");
        if (parts.length === 2){
            return parts.pop().split(";").shift()
        }
    }

    // Function to update map position based on scroll and window resize
    function updateMapPosition() {
        var containerRect = container.getBoundingClientRect();
        var containerHeight = containerRect.height;
        var mapHeight = mapContainer.clientHeight;
        var aboutRect = aboutSection.getBoundingClientRect();
        var aboutTop = aboutRect.top;

        var scrollTop = window.scrollY;

        var topPosition = Math.min(scrollTop + 150, aboutTop - mapHeight + 25);
        mapContainer.style.top = topPosition + "px";
    }

    // Function to set favorite farmers in local storage
    function setFavFarmers(userId){
        favId = "favorites_" + userId;
        fav_farmers = localStorage.getItem(favId);
        document.cookie = "fav=" + fav_farmers;
    }

    // Event listeners for DOM content loaded
    document.addEventListener("DOMContentLoaded", function () {
        // Event listener for favorite button
        var favButton = document.getElementById("fav");
        favButton.addEventListener("click", function(){
            var userId = this.dataset.id;
            setFavFarmers(userId);
        });

        // Initial update of map position
        updateMapPosition();

        // Delayed update of map position
        setTimeout(updateMapPosition, 500);

        // Event listeners for scroll and resize
        window.addEventListener("scroll", updateMapPosition);
        window.addEventListener("resize", updateMapPosition);
    });

    // Event listener for DOM content loaded
    document.addEventListener("DOMContentLoaded", function () {
        // Event listener for clear filters button
        var clearFiltersButton = document.getElementById("clear-filters");
        var filterRadios = document.querySelectorAll('.filter-options input[type="radio"]');

        clearFiltersButton.addEventListener("click", function () {
            // Clear all radio button selections
            filterRadios.forEach(function (radio) {
                radio.checked = false;
            });
        });
    });
</script>

{% endblock %}
